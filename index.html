<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Gases Ideales v6.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .control-panel {
            background-color: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
        }
        .control-panel::-webkit-scrollbar { width: 6px; }
        .control-panel::-webkit-scrollbar-track { background: transparent; }
        .control-panel::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 3px; }

        #gas-container-wrapper {
            position: relative;
            width: 98%;
            max-width: 550px;
            margin: 3rem 1rem 48px auto; /* Aumentado margen superior */
        }
        #gas-container {
            position: relative;
            /* width y transform se manejan por JS */
            height: 300px; /* Altura reducida */
            background: rgba(156, 163, 175, 0.05);
            border: 3px solid rgba(209, 213, 219, 0.3);
            border-top: none; 
            border-radius: 0 0 12px 12px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.6);
            overflow: visible; /* Permitir que las partículas se vean fuera */
        }
        #wall-handle {
            position: absolute;
            left: -8px; 
            top: 50%;
            transform: translateY(-50%);
            height: 80px;
            width: 16px;
            background: linear-gradient(90deg, #6b7280, #9ca3af);
            cursor: ew-resize;
            z-index: 15;
            border-radius: 4px;
            border: 1px solid #4b5563;
            box-shadow: 2px 0 5px rgba(0,0,0,0.4);
            display: none; 
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
        }
        #wall-handle::before, #wall-handle::after {
            content: ''; width: 2px; height: 20px; background-color: rgba(0,0,0,0.3); border-radius: 1px;
        }
        
        #gas-canvas {
            position: absolute;
            top: -150px; /* Espacio extra arriba para ver las partículas escapar */
            left: 0;
            width: 100%;
            height: calc(100% + 150px);
            z-index: 1;
        }

        #lid {
            position: absolute;
            top: -10px;
            left: 0;
            width: 100%; 
            height: 10px;
            background-color: #9ca3af;
            z-index: 10;
        }
        #lid-handle {
            position: absolute; top: -18px; right: -25px; width: 60px; height: 30px; 
            background: linear-gradient(145deg, #e0e0e0, #bcbcbc);
            border-radius: 6px; border: 1px solid #6b7280;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4), inset 1px 1px 2px #fff;
            display: flex; align-items: center; justify-content: space-around;
            padding: 0 5px; cursor: ew-resize;
        }
        #lid-handle::before, #lid-handle::after {
            content: ''; display: block; width: 4px; height: 20px; background-color: rgba(0,0,0,0.15); border-radius: 2px;
        }

        .temp-controls.disabled { opacity: 0.4; pointer-events: none; transition: opacity 0.3s; }
        .radio-label { position: relative; cursor: pointer; user-select: none; padding-left: 30px; }
        .radio-label input { position: absolute; opacity: 0; cursor: pointer; }
        .radio-dot { position: absolute; top: 0; left: 0; height: 20px; width: 20px; background-color: #334155; border: 1px solid #475569; border-radius: 50%; transition: background-color: 0.2s; }
        .radio-label:hover input ~ .radio-dot { background-color: #475569; }
        .radio-label input:checked ~ .radio-dot { background-color: #4f46e5; border-color: #4f46e5; }
        .radio-dot:after { content: ""; position: absolute; display: none; top: 5px; left: 5px; width: 10px; height: 10px; border-radius: 50%; background: white; }
        .radio-label input:checked ~ .radio-dot:after { display: block; }
        
        .checkbox-label { position: relative; cursor: pointer; user-select: none; padding-left: 30px; }
        .checkbox-label input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .checkmark { position: absolute; top: 0; left: 0; height: 20px; width: 20px; background-color: #334155; border: 1px solid #475569; border-radius: 4px; transition: background-color: 0.2s; }
        .checkbox-label:hover input ~ .checkmark { background-color: #475569; }
        .checkbox-label input:checked ~ .checkmark { background-color: #4f46e5; }
        .checkmark:after { content: ""; position: absolute; display: none; left: 6px; top: 2px; width: 5px; height: 10px; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); }
        .checkbox-label input:checked ~ .checkmark:after { display: block; }

        #charles-options {
            padding-left: 20px;
            margin-top: 10px;
            border-left: 2px solid #334155;
        }
        
        #width-ruler {
            position: absolute; bottom: -30px; left: 0; height: 20px;
            display: none; /* Oculto por defecto */
            align-items: center; 
            justify-content: center;
        }
        #width-ruler-line {
            position: absolute; left: 0; top: 50%; width: 100%; height: 1px;
            border-top: 1px dashed #9ca3af;
        }
        #width-ruler-text {
            background-color: #e2e8f0; color: #1e293b; padding: 2px 8px; border-radius: 4px;
            font-size: 0.8rem; font-weight: 600; z-index: 1;
        }
        .ruler-end { position: absolute; top: 50%; transform: translateY(-50%); width: 1px; height: 10px; background-color: #9ca3af; }
        .ruler-end::before { content: ''; position: absolute; top: 50%; transform: translateY(-50%); border-style: solid; }
        .ruler-end.left::before { left: -4px; border-width: 4px 5px 4px 0; border-color: transparent #9ca3af transparent transparent;}
        .ruler-end.right::before { right: -4px; border-width: 4px 0 4px 5px; border-color: transparent transparent transparent #9ca3af;}

        .widget {
            background-color: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(5px);
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 0.25rem 0.5rem;
        }

        .widget-btn {
            background-color: #334155;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e2e8f0;
            transition: background-color 0.2s;
            font-size: 0.75rem;
        }
        .widget-btn:hover { background-color: #475569; }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #popup-overlay {
            transition: opacity 0.3s;
        }
        #popup-box {
            transition: opacity 0.3s, transform 0.3s;
            max-height: 80vh; /* Para popups largos */
            overflow-y: auto; /* Para popups largos */
        }
        #popup-box::-webkit-scrollbar { width: 6px; }
        #popup-box::-webkit-scrollbar-track { background: #1e293b; }
        #popup-box::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 3px; }

        #popup-box.hidden {
            transform: translate(-50%, -50%) scale(0.95);
        }

        #data-table-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #334155;
            border-radius: 6px;
        }
        #data-table-container::-webkit-scrollbar { width: 5px; }
        #data-table-container::-webkit-scrollbar-track { background: #1e293b; }
        #data-table-container::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 3px; }
        #data-table {
            width: 100%;
            font-size: 0.7rem;
            text-align: center;
        }
        #data-table th, #data-table td {
            padding: 4px 2px;
        }
        #data-table thead {
            position: sticky;
            top: 0;
            background-color: #1e293b;
        }

        @keyframes container-shake {
            0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake { animation: container-shake 0.5s ease-in-out; }
        @keyframes flashing-red-anim {
            0%, 100% { color: #ef4444; text-shadow: 0 0 5px #ef4444; } 50% { color: #f87171; text-shadow: 0 0 15px #f87171; }
        }
        .flashing-red { animation: flashing-red-anim 0.8s infinite; }
    </style>
</head>
<body class="text-gray-300 flex flex-col md:flex-row">

    <!-- Columna de Simulación (60%) -->
    <div class="w-full md:w-[60%] flex flex-col">
        <div id="simulation-container" class="relative md:min-h-screen bg-[#020617] flex flex-col items-center p-4 overflow-hidden">
            
            <div id="info-hud" class="w-full max-w-lg bg-slate-900/70 backdrop-blur-sm p-2 rounded-lg z-20 border border-slate-700 shadow-lg flex-shrink-0">
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-x-4 gap-y-1 text-center">
                    <div>
                        <p class="text-[10px] text-gray-400 uppercase tracking-wider">Presión</p>
                        <p id="pressure-display" class="text-sm font-semibold text-green-400 transition-colors duration-300 cursor-pointer" title="Cambiar unidad de presión">0.00 atm</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-400 uppercase tracking-wider">Volumen</p>
                        <p id="volume-display" class="text-sm font-semibold text-white">10.0 L</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-400 uppercase tracking-wider">Partículas</p>
                        <p id="particles-display" class="text-sm font-semibold text-white">0</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-400 uppercase tracking-wider">Temperatura</p>
                        <p id="temp-display" class="text-sm font-semibold text-white cursor-pointer" title="Cambiar unidad de temperatura">300 K</p>
                    </div>
                </div>
            </div>

            <div id="widget-area" class="w-full max-w-lg mt-2 flex justify-start gap-4 z-20">
                <div id="stopwatch" class="widget hidden">
                    <div class="flex items-center gap-2">
                        <span id="stopwatch-display" class="font-mono text-lg text-cyan-400 w-16 text-center">0 ps</span>
                        <button id="stopwatch-play-pause" class="widget-btn">▶</button>
                        <button id="stopwatch-reset" class="widget-btn">⟳</button>
                    </div>
                </div>
                 <div id="collision-counter" class="widget hidden">
                     <div class="flex items-center gap-2">
                         <span id="collision-count-display" class="font-mono text-lg text-amber-400 w-12 text-center">0</span>
                          <select id="collision-sample-time" class="bg-slate-700 border border-slate-600 rounded p-1 text-xs w-14">
                              <option value="1">1 ps</option>
                              <option value="5">5 ps</option>
                              <option value="10" selected>10 ps</option>
                              <option value="20">20 ps</option>
                          </select>
                         <button id="collision-start" class="widget-btn">▶</button>
                     </div>
                </div>
            </div>

            <div id="gas-container-wrapper">
                <div id="gas-container">
                    <canvas id="gas-canvas"></canvas>
                    <div id="lid">
                        <div id="lid-handle"></div>
                    </div>
                     <div id="width-ruler">
                         <div class="ruler-end left"></div>
                         <div id="width-ruler-line"></div>
                         <span id="width-ruler-text">10.0 nm</span>
                         <div class="ruler-end right"></div>
                     </div>
                </div>
                <div id="wall-handle"></div>
            </div>
            
            <!-- El div espaciador que causaba problemas en móvil ha sido eliminado -->

            <div id="temp-controls" class="w-full max-w-xs flex items-center justify-center p-2 mb-4 bg-slate-900/70 backdrop-blur-sm rounded-full border border-slate-700 gap-2 z-20">
                <button id="temp-minus-btn" class="temp-control-btn w-12 h-12 rounded-full text-2xl flex items-center justify-center transition-transform active:scale-90">🧊</button>
                <div class="w-24 h-12 bg-slate-800 rounded-full flex items-center justify-center font-bold text-lg" id="temp-box">
                    <span id="temp-box-display">300 K</span>
                </div>
                <button id="temp-plus-btn" class="temp-control-btn w-12 h-12 rounded-full text-2xl flex items-center justify-center transition-transform active:scale-90">🔥</button>
            </div>
        </div>
    </div>
    
    <!-- Popup -->
    <div id="popup-overlay" class="fixed inset-0 bg-black/50 z-40 hidden opacity-0"></div>
    <div id="popup-box" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-800 border border-slate-600 rounded-lg p-6 z-50 hidden opacity-0 w-full max-w-lg">
        <h3 id="popup-title" class="text-lg font-bold text-sky-400 mb-2"></h3>
        <div id="popup-message" class="text-gray-300 mb-4 text-sm"></div>
        <button id="popup-close" class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
    </div>


    <!-- Panel de Controles (40%) -->
    <div class="w-full md:w-[40%] control-panel p-5 z-10 border-t md:border-t-0 md:border-l border-slate-800 md:h-screen md:sticky md:top-0 md:overflow-y-auto flex flex-col">
        <!-- Botones Superiores -->
        <div class="flex justify-start gap-2 pb-4 border-b border-slate-700 mb-4">
            <button id="info-btn" class="px-4 py-1.5 bg-sky-600 hover:bg-sky-700 text-white font-semibold text-xs rounded-md transition flex-grow">Info</button>
            <button id="top-reset-btn" class="px-4 py-1.5 bg-green-600 hover:bg-green-700 text-white font-semibold text-xs rounded-md transition flex-grow">Reiniciar</button>
        </div>

        <div class="max-w-md mx-auto space-y-4 flex-grow w-full">
            
            <div class="space-y-4">
                <div class="bg-slate-800/50 p-3 rounded-lg space-y-3">
                    <div class="p-2 rounded-lg">
                        <span class="font-semibold text-white block text-center mb-2 text-xs">Partículas Ligeras</span>
                        <div class="flex items-center justify-between gap-2">
                             <button id="add-light-1" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold w-10 h-8 rounded-md text-sm transition flex-shrink-0">+1</button>
                             <span id="light-particles-count" class="font-mono text-xl text-cyan-400 bg-slate-800 w-12 text-center py-1 rounded-md">0</span>
                             <button id="add-light-10" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold w-10 h-8 rounded-md text-sm transition flex-shrink-0">+10</button>
                        </div>
                    </div>
                     <div class="p-2 rounded-lg">
                        <span class="font-semibold text-white block text-center mb-2 text-xs">Partículas Pesadas</span>
                        <div class="flex items-center justify-between gap-2">
                             <button id="add-heavy-1" class="bg-rose-600 hover:bg-rose-700 text-white font-bold w-10 h-8 rounded-md text-sm transition flex-shrink-0">+1</button>
                             <span id="heavy-particles-count" class="font-mono text-xl text-rose-400 bg-slate-800 w-12 text-center py-1 rounded-md">0</span>
                             <button id="add-heavy-10" class="bg-rose-600 hover:bg-rose-700 text-white font-bold w-10 h-8 rounded-md text-sm transition flex-shrink-0">+10</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="space-y-3 pt-4 border-t border-slate-700">
                <h3 class="text-sm font-bold text-sky-400 mb-2">Leyes de los Gases</h3>
                <div id="gas-laws-controls" class="bg-slate-800/50 p-4 rounded-lg space-y-3">
                    <label class="radio-label block text-white text-xs">Exploración Libre
                        <input type="radio" name="gas-law" value="none" checked>
                        <span class="radio-dot"></span>
                    </label>
                    <label class="radio-label block text-white text-xs">Boyle (T constante)
                        <input type="radio" name="gas-law" value="T">
                        <span class="radio-dot"></span>
                    </label>
                    <label class="radio-label block text-white text-xs">Gay-Lussac (V constante)
                        <input type="radio" name="gas-law" value="V">
                        <span class="radio-dot"></span>
                    </label>
                    <div>
                        <label class="radio-label block text-white text-xs">Charles (P constante)
                            <input type="radio" name="gas-law" value="P">
                            <span class="radio-dot"></span>
                        </label>
                        <div id="charles-options" class="space-y-2 hidden">
                            <label class="radio-label block text-white text-xs">Variar Temperatura (V se ajusta)
                                <input type="radio" name="charles-mode" value="P_mod_T" checked>
                                <span class="radio-dot"></span>
                            </label>
                            <label class="radio-label block text-white text-xs">Variar Volumen (T se ajusta)
                                <input type="radio" name="charles-mode" value="P_mod_V">
                                <span class="radio-dot"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-3 pt-4 border-t border-slate-700">
                <h3 class="text-sm font-bold text-sky-400 mb-2">Herramientas de Visualización</h3>
                <div class="bg-slate-800/50 p-4 rounded-lg space-y-3">
                    <label class="checkbox-label block text-white text-xs">Medidas del Recipiente
                        <input type="checkbox" id="width-ruler-checkbox">
                        <span class="checkmark"></span>
                    </label>
                    <label class="checkbox-label block text-white text-xs">Cronómetro
                        <input type="checkbox" id="stopwatch-checkbox">
                        <span class="checkmark"></span>
                    </label>
                    <label class="checkbox-label block text-white text-xs">Contador de Colisiones
                        <input type="checkbox" id="collision-counter-checkbox">
                        <span class="checkmark"></span>
                    </label>
                </div>
            </div>

            <div class="space-y-2 pt-4 border-t border-slate-700">
                <h3 class="text-sm font-bold text-sky-400 mb-2">Parámetros del Sistema</h3>
                <div class="bg-slate-800/50 p-3 rounded-lg text-xs space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Presión: </span>
                        <span id="pressure-value-display" class="font-semibold text-white text-right">0.00 atm / 0.0 kPa</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Temperatura: </span>
                        <span id="temp-value-display" class="font-semibold text-white text-right">300 K / 27 °C</span>
                    </div>
                </div>
            </div>

            <!-- Registro de Datos -->
            <div class="space-y-3 pt-4 border-t border-slate-700">
                <h3 class="text-sm font-bold text-sky-400 mb-2">Registro de Datos</h3>
                <div class="bg-slate-800/50 p-3 rounded-lg space-y-3">
                    <button id="add-data-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-all text-sm">Añadir Datos a la Tabla</button>
                    <div id="data-table-container">
                        <table id="data-table">
                            <thead>
                                <tr>
                                    <th>Ley</th>
                                    <th>P(atm)</th>
                                    <th>V(L)</th>
                                    <th>T(K)</th>
                                    <th>N</th>
                                    <th>N(H)</th>
                                    <th>N(L)</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body">
                                <!-- Filas de datos se insertarán aquí -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex gap-2">
                         <button id="export-csv-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-all text-sm">Exportar CSV</button>
                         <button id="clear-data-btn" class="w-full bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg transition-all text-sm">Limpiar Tabla</button>
                    </div>
                </div>
            </div>
            
        </div>
        <footer class="p-2 text-center text-xs text-gray-500 z-20 mt-auto pt-4">
            Simulación creada por <a href="https://aulaquest.com" target="_blank" rel="noopener noreferrer" class="underline hover:text-indigo-400">Aulaquest</a>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const dom = {
            canvas: document.getElementById('gas-canvas'),
            simulationContainer: document.getElementById('simulation-container'),
            container: document.getElementById('gas-container'),
            containerWrapper: document.getElementById('gas-container-wrapper'),
            pressureDisplay: document.getElementById('pressure-display'),
            volumeDisplay: document.getElementById('volume-display'),
            particlesDisplay: document.getElementById('particles-display'),
            tempDisplay: document.getElementById('temp-display'),
            tempBoxDisplay: document.getElementById('temp-box-display'),
            tempControls: document.getElementById('temp-controls'),
            pressureValueDisplay: document.getElementById('pressure-value-display'),
            tempValueDisplay: document.getElementById('temp-value-display'),
            addLight1: document.getElementById('add-light-1'),
            addLight10: document.getElementById('add-light-10'),
            addHeavy1: document.getElementById('add-heavy-1'),
            addHeavy10: document.getElementById('add-heavy-10'),
            lightParticlesCount: document.getElementById('light-particles-count'),
            heavyParticlesCount: document.getElementById('heavy-particles-count'),
            topResetBtn: document.getElementById('top-reset-btn'),
            infoBtn: document.getElementById('info-btn'),
            lid: document.getElementById('lid'),
            gasLawsControls: document.getElementById('gas-laws-controls'),
            charlesOptions: document.getElementById('charles-options'),
            wallHandle: document.getElementById('wall-handle'),
            tempPlusBtn: document.getElementById('temp-plus-btn'),
            tempMinusBtn: document.getElementById('temp-minus-btn'),
            widthRulerCheckbox: document.getElementById('width-ruler-checkbox'),
            widthRuler: document.getElementById('width-ruler'),
            widthRulerText: document.getElementById('width-ruler-text'),
            stopwatchCheckbox: document.getElementById('stopwatch-checkbox'),
            stopwatch: document.getElementById('stopwatch'),
            stopwatchDisplay: document.getElementById('stopwatch-display'),
            stopwatchPlayPause: document.getElementById('stopwatch-play-pause'),
            stopwatchReset: document.getElementById('stopwatch-reset'),
            collisionCounterCheckbox: document.getElementById('collision-counter-checkbox'),
            collisionCounter: document.getElementById('collision-counter'),
            collisionCountDisplay: document.getElementById('collision-count-display'),
            collisionSampleTime: document.getElementById('collision-sample-time'),
            collisionStart: document.getElementById('collision-start'),
            popupOverlay: document.getElementById('popup-overlay'),
            popupBox: document.getElementById('popup-box'),
            popupTitle: document.getElementById('popup-title'),
            popupMessage: document.getElementById('popup-message'),
            popupClose: document.getElementById('popup-close'),
            addDataBtn: document.getElementById('add-data-btn'),
            dataTableBody: document.getElementById('data-table-body'),
            exportCsvBtn: document.getElementById('export-csv-btn'),
            clearDataBtn: document.getElementById('clear-data-btn'),
        };

        const ctx = dom.canvas.getContext('2d');
        let particles = [];
        let escapedParticles = []; // Nuevo array para partículas que escapan
        let dataLog = [];
        let animationFrameId;
        let tempInterval, animationInterval, stopwatchInterval, collisionTimeout;
        
        const R = 0.0821, MAX_PRESSURE = 50, MAX_VOLUME = 12.0;
        let maxContainerWidth = 0, wallCollisionCount = 0;

        let state = {
            pressure: 0.0, volume: MAX_VOLUME, temperature: 300, lightCount: 0, heavyCount: 0,
            lidOpenRatio: 0.0, isDraggingLid: false, isDraggingWall: false, 
            constantParam: 'none',
            targetPressure: 0,
            wallVelocity: 0,
            maxVolumeWarningShown: false,
            minVolumeWarningShown: false,
            pressureUnit: 'atm', tempUnit: 'K',
            stopwatchRunning: false, stopwatchTime: 0, stopwatchStart: 0,
            isCountingCollisions: false,
        };

        class Particle {
            constructor(type, isEscaped = false) {
                this.isLight = type === 'light';
                this.radius = this.isLight ? 4 : 7;
                this.mass = this.isLight ? 1 : 4;
                this.color = this.isLight ? '#06b6d4' : '#f43f5e';
                this.opacity = 1.0;
                
                const containerWidth = dom.container.clientWidth;
                this.x = this.radius + Math.random() * (containerWidth - 2 * this.radius);
                this.y = this.radius + Math.random() * (dom.container.clientHeight - 2 * this.radius);
                
                const angle = Math.random() * 2 * Math.PI;
                const speed = (Math.sqrt(state.temperature) / this.mass) * 0.5;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
            }

            draw(yOffset = 0) {
                ctx.globalAlpha = this.opacity;
                ctx.beginPath();
                ctx.arc(this.x, this.y + yOffset, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.closePath();
                ctx.globalAlpha = 1.0;
            }
            
            handleWallCollisions(containerWidth, leftWallVel) {
                let collision = false;
                if (this.x - this.radius < 0) {
                    this.vx = 2 * leftWallVel - this.vx;
                    this.x = this.radius;
                    collision = true;
                }
                
                if (this.x + this.radius > containerWidth) {
                    this.vx *= -1;
                    this.x = containerWidth - this.radius;
                    collision = true;
                }
                
                if (this.y + this.radius > dom.container.clientHeight) { 
                    this.vy *= -1; 
                    this.y = dom.container.clientHeight - this.radius; 
                    collision = true; 
                }
                const lidClosedWidth = (1 - state.lidOpenRatio) * containerWidth;
                if (this.y - this.radius < 0) {
                    if (this.x > lidClosedWidth) { return false; } 
                    else {
                        this.vy *= -1;
                        this.y = this.radius;
                        collision = true;
                    }
                }
                
                if (state.isCountingCollisions && collision) wallCollisionCount++;
                return true; 
            }
        }

        function resolveCollision(p1, p2) {
             const dx = p2.x - p1.x;
             const dy = p2.y - p1.y;
             let dist = Math.sqrt(dx * dx + dy * dy);
             if (dist < p1.radius + p2.radius) {
                 if (dist === 0) dist = 0.0001;
                 const nx = dx / dist; const ny = dy / dist; const tx = -ny; const ty = nx;
                 const dpTan1 = p1.vx * tx + p1.vy * ty; const dpTan2 = p2.vx * tx + p2.vy * ty;
                 const dpNorm1 = p1.vx * nx + p1.vy * ny; const dpNorm2 = p2.vx * nx + p2.vy * ny;
                 const m1 = (dpNorm1 * (p1.mass - p2.mass) + 2 * p2.mass * dpNorm2) / (p1.mass + p2.mass);
                 const m2 = (dpNorm2 * (p2.mass - p1.mass) + 2 * p1.mass * dpNorm1) / (p1.mass + p2.mass);
                 p1.vx = tx * dpTan1 + nx * m1; p1.vy = ty * dpTan1 + ny * m1;
                 p2.vx = tx * dpTan2 + nx * m2; p2.vy = ty * dpTan2 + ny * m2;
                 const overlap = p1.radius + p2.radius - dist;
                 if (overlap > 0) {
                     const separationX = overlap * nx * 0.5; const separationY = overlap * ny * 0.5;
                     p1.x -= separationX; p1.y -= separationY; p2.x += separationX; p2.y += separationY;
                 }
             }
        }

        function resizeCanvas() {
            dom.canvas.width = dom.container.clientWidth;
            dom.canvas.height = dom.container.clientHeight + 150;
        }

        function addParticles(type, count) {
            for(let i=0; i<count; i++) {
                particles.push(new Particle(type));
            }
            state[type === 'light' ? 'lightCount' : 'heavyCount'] += count;
            
            if(state.constantParam.startsWith('P')) {
                 calculatePressure();
                 state.targetPressure = state.pressure;
            }
        }

        function calculatePressure() {
             const n = (state.lightCount + state.heavyCount) / 100;
             state.pressure = state.volume > 0.1 ? (n * R * state.temperature) / state.volume : (n * R * state.temperature) / 0.1;
        }
        
        function updateDisplays() {
            calculatePressure();
            
            let pressureToDisplay = state.pressure;
            if (state.constantParam.startsWith('P') && state.targetPressure > 0 && state.lidOpenRatio === 0) {
                 pressureToDisplay = state.targetPressure;
            }

            const pressureAtm = pressureToDisplay;
            const pressureKpa = pressureToDisplay * 101.325;
            const tempK = state.temperature;
            const tempC = state.temperature - 273.15;

            const pressureValue = state.pressureUnit === 'atm' ? pressureAtm : pressureKpa;
            const pressureUnitLabel = state.pressureUnit === 'atm' ? 'atm' : 'kPa';
            dom.pressureDisplay.textContent = `${pressureValue.toFixed(2)} ${pressureUnitLabel}`;
            
            const tempValue = state.tempUnit === 'K' ? tempK : tempC;
            const tempUnitLabel = state.tempUnit === 'K' ? 'K' : '°C';
            dom.tempDisplay.textContent = `${tempValue.toFixed(0)} ${tempUnitLabel}`;
            dom.tempBoxDisplay.textContent = `${tempValue.toFixed(0)} ${tempUnitLabel}`;
            
            dom.pressureValueDisplay.textContent = `${pressureAtm.toFixed(2)} atm / ${pressureKpa.toFixed(1)} kPa`;
            dom.tempValueDisplay.textContent = `${tempK.toFixed(0)} K / ${tempC.toFixed(0)} °C`;

            dom.particlesDisplay.textContent = state.lightCount + state.heavyCount;
            dom.lightParticlesCount.textContent = state.lightCount;
            dom.heavyParticlesCount.textContent = state.heavyCount;

            const pressureEl = dom.pressureDisplay;
            pressureEl.classList.remove('text-green-400', 'text-yellow-400', 'text-orange-400', 'text-red-500', 'flashing-red');
            if (pressureToDisplay > MAX_PRESSURE - 2) { pressureEl.classList.add('flashing-red'); } 
            else if (pressureToDisplay > 40) { pressureEl.classList.add('text-red-500'); } 
            else if (pressureToDisplay > 25) { pressureEl.classList.add('text-orange-400'); } 
            else if (pressureToDisplay > 10) { pressureEl.classList.add('text-yellow-400'); } 
            else { pressureEl.classList.add('text-green-400'); }
            
            const containerWidth = dom.container.clientWidth;
            if (maxContainerWidth > 0) {
                state.volume = MAX_VOLUME * (containerWidth / maxContainerWidth);
            } else {
                state.volume = 0;
            }
            dom.volumeDisplay.textContent = `${state.volume.toFixed(1)} L`;
            dom.widthRulerText.textContent = `${(state.volume * 0.8).toFixed(1)} nm`;
            dom.widthRuler.style.width = `${containerWidth}px`;
        }
        
        function resetSimulation() {
            cancelAnimationFrame(animationFrameId);
            document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
            document.querySelector('input[name="gas-law"][value="none"]').checked = true;
            document.querySelector('input[name="charles-mode"][value="P_mod_T"]').checked = true;

            ['width-ruler-checkbox', 'stopwatch-checkbox', 'collision-counter-checkbox'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.checked = false;
            });
            
            dom.widthRuler.style.display = 'none';
            dom.stopwatch.classList.add('hidden');
            dom.collisionCounter.classList.add('hidden');
            
            maxContainerWidth = dom.containerWrapper.clientWidth;

            const initialContainerWidth = maxContainerWidth * 0.6;
            const initialTranslateX = maxContainerWidth - initialContainerWidth;

            state = { pressure: 0.0, volume: MAX_VOLUME * (initialContainerWidth/maxContainerWidth), temperature: 300, lightCount: 0, heavyCount: 0, lidOpenRatio: 0.0, isDraggingLid: false, isDraggingWall: false, constantParam: 'none', targetPressure: 0, wallVelocity: 0, maxVolumeWarningShown: false, minVolumeWarningShown: false, pressureUnit: 'atm', tempUnit: 'K', stopwatchRunning: false, stopwatchTime: 0, stopwatchStart: 0, isCountingCollisions: false };
            particles = [];
            escapedParticles = [];
            wallCollisionCount = 0;
            clearDataLog();
            
            dom.container.style.width = `${initialContainerWidth}px`;
            dom.container.style.transform = `translateX(${initialTranslateX}px)`;
            
            updateConstantState('none');
            resizeCanvas();

            updateDisplays();
            dom.lid.style.left = `0%`; dom.lid.style.width = '100%'; dom.lid.style.transition = 'none';
            resetStopwatch();
            dom.collisionCountDisplay.textContent = 0;

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function handleResize() {
            const oldContainerWidthRatio = dom.container.clientWidth / maxContainerWidth;
            
            maxContainerWidth = dom.containerWrapper.clientWidth;

            const newWidth = maxContainerWidth * oldContainerWidthRatio;
            const newLeft = maxContainerWidth - newWidth;

            dom.container.style.transform = `translateX(${newLeft}px)`;
            dom.container.style.width = `${newWidth}px`;
            
            resizeCanvas();

            if(state.constantParam === 'T' || state.constantParam === 'P_mod_V') {
                 dom.wallHandle.style.transform = `translateY(-50%) translateX(${newLeft}px)`;
            }
        }

        function blowLid() {
             state.lidOpenRatio = 1.0;
             dom.lid.style.transition = 'width 0.2s ease-out';
             dom.lid.style.width = '0%';
             dom.containerWrapper.classList.add('shake');
             setTimeout(() => dom.containerWrapper.classList.remove('shake'), 500);
        }

        function showPopup(title, message) {
            dom.popupTitle.textContent = title;
            dom.popupMessage.innerHTML = message;
            dom.popupOverlay.classList.remove('hidden');
            dom.popupBox.classList.remove('hidden');
            setTimeout(() => {
                dom.popupOverlay.classList.remove('opacity-0');
                dom.popupBox.classList.remove('opacity-0');
            }, 10);
        }

        function hidePopup() {
            dom.popupOverlay.classList.add('opacity-0');
            dom.popupBox.classList.add('opacity-0');
            setTimeout(() => {
                dom.popupOverlay.classList.add('hidden');
                dom.popupBox.classList.add('hidden');
            }, 300);
        }

        function gameLoop() {
            ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height);
            
            const oldWidth = dom.container.clientWidth;
            state.wallVelocity = 0;

            if (state.constantParam === 'P_mod_T' && state.targetPressure > 0 && !state.isDraggingWall && state.lidOpenRatio === 0) {
                const n = (state.lightCount + state.heavyCount) / 100;
                if (n > 0) {
                    const targetVolume = (n * R * state.temperature) / state.targetPressure;
                    let targetWidth = (targetVolume / MAX_VOLUME) * maxContainerWidth;
                    const minContainerWidth = maxContainerWidth * 0.15;

                    dom.tempPlusBtn.disabled = false;
                    dom.tempMinusBtn.disabled = false;

                    if (targetWidth >= maxContainerWidth) {
                        targetWidth = maxContainerWidth;
                        dom.tempPlusBtn.disabled = true;
                        if (!state.maxVolumeWarningShown) { showPopup("Límite Alcanzado", "Volumen máximo alcanzado."); state.maxVolumeWarningShown = true; }
                        stopTempChange();
                    } else { state.maxVolumeWarningShown = false; } 
                    
                    if (targetWidth <= minContainerWidth) {
                        targetWidth = minContainerWidth;
                        dom.tempMinusBtn.disabled = true;
                        if (!state.minVolumeWarningShown) { showPopup("Límite Alcanzado", "Volumen mínimo alcanzado."); state.minVolumeWarningShown = true; }
                        stopTempChange();
                    } else { state.minVolumeWarningShown = false; }

                    const deltaWidth = targetWidth - oldWidth;
                    state.wallVelocity = deltaWidth * 0.1; 
                    
                    const newWidth = oldWidth + state.wallVelocity;
                    const newLeft = maxContainerWidth - newWidth;
                    dom.container.style.transform = `translateX(${newLeft}px)`;
                    dom.container.style.width = `${newWidth}px`;
                }
            }
            
            const currentWidth = dom.container.clientWidth;
            const oldLeft = maxContainerWidth - oldWidth;
            const newLeft = maxContainerWidth - currentWidth;
            const leftWallVelocity = newLeft - oldLeft;

            const remainingParticles = [];
            particles.forEach((p) => {
                p.x += p.vx;
                p.y += p.vy;
                if (p.x - p.radius < leftWallVelocity) {
                    p.x += leftWallVelocity;
                }
                
                for (let j = 0; j < particles.length; j++) { if (p !== particles[j]) resolveCollision(p, particles[j]); }
                const isInContainer = p.handleWallCollisions(currentWidth, leftWallVelocity);
                if (isInContainer) { 
                    remainingParticles.push(p); 
                } else {
                    escapedParticles.push(p);
                    if (p.isLight) { state.lightCount = Math.max(0, state.lightCount - 1); } 
                    else { state.heavyCount = Math.max(0, state.heavyCount - 1); }
                }
            });
            particles = remainingParticles;

            escapedParticles = escapedParticles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.opacity -= 0.01;
                return p.opacity > 0;
            });
            
            particles.forEach(p => p.draw(150));
            escapedParticles.forEach(p => p.draw(150));

            updateDisplays();
            
            if (state.pressure > MAX_PRESSURE && state.lidOpenRatio < 1.0) blowLid();

            animationFrameId = requestAnimationFrame(gameLoop);
        }
        
        function createTempAnimation(type) {
            const particleEl = document.createElement('div');
            particleEl.textContent = type === 'heat' ? '🔥' : '🧊';
            particleEl.className = type === 'heat' ? 'heat-particle' : 'ice-particle';
            particleEl.style.left = `${Math.random() * 80 + 10}%`;
            dom.simulationContainer.appendChild(particleEl);
            setTimeout(() => particleEl.remove(), 1500);
        }
        
        function startTempChange(direction) {
            if (tempInterval || dom.tempControls.classList.contains('disabled') || particles.length === 0) return;
            const change = () => {
                const oldTemp = state.temperature;
                state.temperature = Math.max(1, Math.min(1000, state.temperature + direction));
                const tempRatio = Math.sqrt(state.temperature / oldTemp);
                particles.forEach(p => { p.vx *= tempRatio; p.vy *= tempRatio; });
            };
            change();
            tempInterval = setInterval(change, 100);
            animationInterval = setInterval(() => createTempAnimation(direction > 0 ? 'heat' : 'cold'), 200);
        }

        function stopTempChange() { clearInterval(tempInterval); clearInterval(animationInterval); tempInterval = null; animationInterval = null; }
        
        function updateConstantState(mode) {
            state.constantParam = mode;
            state.minVolumeWarningShown = false;
            state.maxVolumeWarningShown = false;
            
            const isCharles = mode.startsWith('P');
            dom.charlesOptions.classList.toggle('hidden', !isCharles);

            if (isCharles) {
                if (particles.length > 0) {
                    calculatePressure();
                    state.targetPressure = state.pressure;
                } else { state.targetPressure = 0; }
            } else { state.targetPressure = 0; }

            const currentLeft = parseFloat(dom.container.style.transform.replace('translateX(', '')) || 0;
            const canChangeTemp = (mode === 'none' || mode === 'V' || mode === 'P_mod_T');
            const canChangeVolume = (mode === 'none' || mode === 'T' || mode === 'P_mod_V');
            
            dom.tempControls.classList.toggle('disabled', !canChangeTemp);
            dom.tempPlusBtn.disabled = dom.tempControls.classList.contains('disabled');
            dom.tempMinusBtn.disabled = dom.tempControls.classList.contains('disabled');
            dom.wallHandle.style.display = canChangeVolume ? 'flex' : 'none';
            
            if (canChangeVolume) {
                dom.wallHandle.style.transform = `translateY(-50%) translateX(${currentLeft}px)`;
            }
        }
        
        function playPauseStopwatch() {
            if (state.stopwatchRunning) {
                state.stopwatchTime += performance.now() - state.stopwatchStart;
                state.stopwatchRunning = false;
                dom.stopwatchPlayPause.innerHTML = '▶';
                clearInterval(stopwatchInterval);
            } else {
                state.stopwatchStart = performance.now();
                state.stopwatchRunning = true;
                dom.stopwatchPlayPause.innerHTML = '❚❚';
                stopwatchInterval = setInterval(() => {
                    const elapsed = state.stopwatchTime + (performance.now() - state.stopwatchStart);
                    dom.stopwatchDisplay.textContent = `${Math.floor(elapsed/100)} ps`;
                }, 40);
            }
        }
        function resetStopwatch() {
            state.stopwatchTime = 0; state.stopwatchStart = performance.now();
            if (!state.stopwatchRunning) dom.stopwatchDisplay.textContent = '0 ps';
        }
        function startCollisionCount() {
            if(state.isCountingCollisions) return;
            state.isCountingCollisions = true;
            wallCollisionCount = 0;
            dom.collisionCountDisplay.textContent = '...';
            dom.collisionStart.disabled = true;
            const sampleTimeMs = parseFloat(dom.collisionSampleTime.value) * 100; // 1ps = 100ms
            collisionTimeout = setTimeout(() => {
                state.isCountingCollisions = false;
                dom.collisionCountDisplay.textContent = wallCollisionCount;
                dom.collisionStart.disabled = false;
            }, sampleTimeMs);
        }

        // --- Funciones de Registro de Datos ---
        function getLawName(param) {
            switch(param) {
                case 'none': return 'Libre';
                case 'T': return 'Boyle';
                case 'V': return 'G-Lussac';
                case 'P_mod_T': return 'Charles(T)';
                case 'P_mod_V': return 'Charles(V)';
                default: return 'N/A';
            }
        }

        function addDataToLog() {
            const snapshot = {
                law: getLawName(state.constantParam),
                pressure: state.targetPressure > 0 && state.lidOpenRatio === 0 ? state.targetPressure : state.pressure,
                volume: state.volume,
                temperature: state.temperature,
                totalParticles: state.lightCount + state.heavyCount,
                heavyParticles: state.heavyCount,
                lightParticles: state.lightCount
            };
            dataLog.push(snapshot);
            renderDataLog();
        }

        function renderDataLog() {
            dom.dataTableBody.innerHTML = '';
            dataLog.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.law}</td>
                    <td>${data.pressure.toFixed(2)}</td>
                    <td>${data.volume.toFixed(1)}</td>
                    <td>${data.temperature.toFixed(0)}</td>
                    <td>${data.totalParticles}</td>
                    <td>${data.heavyParticles}</td>
                    <td>${data.lightParticles}</td>
                `;
                dom.dataTableBody.appendChild(row);
            });
        }

        function clearDataLog() {
            dataLog = [];
            renderDataLog();
        }

        function exportDataToCsv() {
            if (dataLog.length === 0) return;
            const headers = "Ley,P (atm),V (L),T (K),N_Total,N_Pesadas,N_Ligeras\n";
            const csvContent = dataLog.map(row => {
                return `${row.law},${row.pressure.toFixed(2)},${row.volume.toFixed(1)},${row.temperature.toFixed(0)},${row.totalParticles},${row.heavyParticles},${row.lightParticles}`;
            }).join('\n');

            const blob = new Blob([headers + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'datos_simulacion_gases.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }


        function init() {
            window.addEventListener('resize', handleResize);
            
            const infoTitle = "Guía de la Simulación de Gases";
            const infoMessage = `
                <div class="space-y-4 text-left">
                    <div>
                        <h4 class="font-bold text-base text-sky-400">Instrucciones Básicas</h4>
                        <ul class="list-disc list-inside text-sm text-gray-300 space-y-1 mt-1">
                            <li><strong>Añadir Partículas:</strong> Usa los botones '+' en el panel derecho para inyectar partículas ligeras (azules) o pesadas (rojas).</li>
                            <li><strong>Controlar Temperatura:</strong> Mantén pulsados los botones 🔥 (calentar) o 🧊 (enfriar) bajo el recipiente.</li>
                            <li><strong>Abrir la Tapa:</strong> Arrastra el tirador gris en la parte superior del recipiente para dejar escapar partículas.</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-base text-sky-400">Leyes de los Gases</h4>
                        <p class="text-xs text-gray-400 mb-2">Selecciona una ley en el panel derecho para mantener un parámetro constante y observar la relación entre los otros dos.</p>
                        <div class="space-y-3">
                            <p><strong>Ley de Boyle (T constante):</strong> A temperatura constante, la presión es inversamente proporcional al volumen. Si reduces el volumen, la presión aumentará. <br><em>Fórmula: P₁V₁ = P₂V₂</em></p>
                            <p><strong>Ley de Gay-Lussac (V constante):</strong> A volumen constante, la presión es directamente proporcional a la temperatura. Si calientas el gas, la presión aumentará. <br><em>Fórmula: P₁/T₁ = P₂/T₂</em></p>
                            <p><strong>Ley de Charles (P constante):</strong> A presión constante, el volumen es directamente proporcional a la temperatura. Si calientas el gas, el volumen se expandirá para mantener la presión estable. <br><em>Fórmula: V₁/T₁ = V₂/T₂</em></p>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold text-base text-sky-400">Herramientas</h4>
                        <ul class="list-disc list-inside text-sm text-gray-300 space-y-1 mt-1">
                            <li><strong>Medidas del Recipiente:</strong> Muestra una regla con el ancho actual del contenedor.</li>
                            <li><strong>Cronómetro:</strong> Mide el tiempo transcurrido en picosegundos (ps).</li>
                            <li><strong>Contador de Colisiones:</strong> Mide el número total de colisiones con las paredes en un intervalo de tiempo seleccionado.</li>
                        </ul>
                    </div>
                </div>
            `;
            
            dom.gasLawsControls.addEventListener('change', (e) => {
                let mode = e.target.value;
                if (mode === 'P') {
                    mode = document.querySelector('input[name="charles-mode"]:checked').value;
                }
                updateConstantState(mode);
            });

            resetSimulation();
            
            dom.infoBtn.addEventListener('click', () => showPopup(infoTitle, infoMessage));
            dom.topResetBtn.addEventListener('click', resetSimulation);
            dom.addLight1.addEventListener('click', () => addParticles('light', 1));
            dom.addLight10.addEventListener('click', () => addParticles('light', 10));
            dom.addHeavy1.addEventListener('click', () => addParticles('heavy', 1));
            dom.addHeavy10.addEventListener('click', () => addParticles('heavy', 10));
            
            dom.widthRulerCheckbox.addEventListener('change', (e) => {
                dom.widthRuler.style.display = e.target.checked ? 'flex' : 'none';
            });

            dom.stopwatchCheckbox.addEventListener('change', (e) => dom.stopwatch.classList.toggle('hidden', !e.target.checked));
            dom.collisionCounterCheckbox.addEventListener('change', (e) => dom.collisionCounter.classList.toggle('hidden', !e.target.checked));
            
            dom.popupClose.addEventListener('click', hidePopup);
            dom.popupOverlay.addEventListener('click', hidePopup);

            dom.pressureDisplay.addEventListener('click', () => { state.pressureUnit = state.pressureUnit === 'atm' ? 'kPa' : 'atm'; });
            dom.tempDisplay.addEventListener('click', () => { state.tempUnit = state.tempUnit === 'K' ? 'C' : 'K'; });
            
            dom.stopwatchPlayPause.addEventListener('click', playPauseStopwatch);
            dom.stopwatchReset.addEventListener('click', resetStopwatch);
            dom.collisionStart.addEventListener('click', startCollisionCount);
            
            dom.addDataBtn.addEventListener('click', addDataToLog);
            dom.clearDataBtn.addEventListener('click', clearDataLog);
            dom.exportCsvBtn.addEventListener('click', exportDataToCsv);

            // --- Lógica de Arrastre Unificada para Ratón y Táctil ---
            
            // Función auxiliar para obtener la coordenada X correcta del evento
            function getClientX(e) {
                return e.touches ? e.touches[0].clientX : e.clientX;
            }

            const startDragLid = (e) => {
                state.isDraggingLid = true;
                if (e.type === 'touchstart') e.preventDefault();
            };

            const startDragWall = (e) => {
                if (state.constantParam === 'none' || state.constantParam === 'T' || state.constantParam === 'P_mod_V') {
                    state.isDraggingWall = true;
                    if (e.type === 'touchstart') e.preventDefault();
                }
            };

            const endDrag = () => {
                state.isDraggingLid = false;
                state.isDraggingWall = false;
            };

            const handleDrag = (e) => {
                if (state.isDraggingLid) {
                    if (e.type === 'touchmove') e.preventDefault();
                    const clientX = getClientX(e);
                    const containerRect = dom.container.getBoundingClientRect();
                    let closedRatio = (clientX - containerRect.left) / containerRect.width;
                    let closedWidthRatio = Math.max(0, Math.min(1, closedRatio));
                    state.lidOpenRatio = 1.0 - closedWidthRatio;
                    dom.lid.style.transition = 'none';
                    dom.lid.style.width = `${closedWidthRatio * 100}%`;
                }
                if (state.isDraggingWall) {
                    if (e.type === 'touchmove') e.preventDefault();
                    const clientX = getClientX(e);
                    const wrapperRect = dom.containerWrapper.getBoundingClientRect();
                    const handleWidth = dom.wallHandle.clientWidth;
                    
                    let newLeft = clientX - wrapperRect.left - (handleWidth / 2);
                    const minContainerWidth = maxContainerWidth * 0.15;
                    const maxLeft = wrapperRect.width - minContainerWidth;
                    newLeft = Math.max(0, Math.min(newLeft, maxLeft));

                    const oldWidth = dom.container.clientWidth;
                    const newWidth = wrapperRect.width - newLeft;
                    
                    dom.container.style.transform = `translateX(${newLeft}px)`;
                    dom.container.style.width = `${newWidth}px`;
                    dom.wallHandle.style.transform = `translateY(-50%) translateX(${newLeft}px)`;

                    if (state.constantParam === 'P_mod_V') {
                        const n = (state.lightCount + state.heavyCount) / 100;
                        if (n > 0) {
                            const currentVolume = MAX_VOLUME * (newWidth / maxContainerWidth);
                            const newTemp = (state.targetPressure * currentVolume) / (n * R);
                            const oldTemp = state.temperature;
                            state.temperature = Math.max(1, Math.min(1000, newTemp));
                            if (oldTemp > 0) {
                                const tempRatio = Math.sqrt(state.temperature / oldTemp);
                                if (Math.abs(tempRatio - 1) > 0.001) {
                                    particles.forEach(p => { p.vx *= tempRatio; p.vy *= tempRatio; });
                                }
                            }
                        }
                    }
                }
            };

            // Eventos para iniciar el arrastre
            dom.lid.addEventListener('mousedown', startDragLid);
            dom.lid.addEventListener('touchstart', startDragLid, { passive: false });

            dom.wallHandle.addEventListener('mousedown', startDragWall);
            dom.wallHandle.addEventListener('touchstart', startDragWall, { passive: false });
            
            // Eventos para mover durante el arrastre
            window.addEventListener('mousemove', handleDrag);
            window.addEventListener('touchmove', handleDrag, { passive: false });
            
            // Eventos para finalizar el arrastre
            window.addEventListener('mouseup', endDrag);
            window.addEventListener('mouseleave', endDrag); // Se mantiene para el ratón
            window.addEventListener('touchend', endDrag);
            window.addEventListener('touchcancel', endDrag);
            
            // Eventos para control de temperatura (también con soporte táctil)
            ['mousedown', 'touchstart'].forEach(evt => {
                dom.tempPlusBtn.addEventListener(evt, (e) => { e.preventDefault(); startTempChange(5); });
                dom.tempMinusBtn.addEventListener(evt, (e) => { e.preventDefault(); startTempChange(-5); });
            });
             ['mouseup', 'mouseleave', 'touchend', 'touchcancel'].forEach(evt => {
                window.addEventListener(evt, stopTempChange);
            });
        }
        
        init();
    });
    </script>
</body>
</html>

